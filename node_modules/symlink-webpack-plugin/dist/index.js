'use strict';

var fs = require('fs');
var path = require('path');

function SymlinkWebpackPlugin() {
  var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];


  var options = void 0;
  if (config instanceof Array) {
    options = config;
  } else {
    options = [config];
  }

  var apply = function apply(compiler) {
    compiler.plugin('after-emit', function (compilation, callback) {
      var makeSymlinks = function makeSymlinks(option) {
        var outputPath = compiler.options.output.path;
        var originPath = path.join(outputPath, option.origin);

        if (fs.existsSync(originPath)) {
          var baseDir = process.cwd();
          process.chdir(outputPath);
          var symlink = path.join(outputPath, option.symlink);
          var origin = path.relative(path.dirname(symlink), originPath);

          if (fs.existsSync(symlink)) fs.unlinkSync(symlink);
          fs.symlinkSync(origin, symlink);

          process.chdir(baseDir);
        }
      };

      options.forEach(makeSymlinks);
      callback();
    });
  };

  return {
    apply: apply
  };
}

module.exports = SymlinkWebpackPlugin;